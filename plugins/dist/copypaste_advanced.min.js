/**
 * Plugin copy paste advance for jSpreadsheet
 *
 * @version 3.3.1
 * @author Guillaume Bonnaire <contact@gbonnaire.fr>
 * @website https://repo.gbonnaire.fr
 * @description upgrade copy paste function for work with clipboard permission denied or error
 * and add button on toolbar copy/cut/paste
 *
 * @license This plugin is distributed under MIT License
 *
 * ReleaseNote
 * 3.3.0 : Add Transpose paste + Add paste only value and formula
 * 3.2.0 : Select several cells to copy & paste
 * 3.1.0 : Migration V10
 * 3.0.0 : version for v8 and v9
 * 2.1.0 : add topmenu compatibility
 * 2.0.1 : transform jexcel to jspreadsheet
 * 2.0.0 : compatibility NPM + add special paste (paste only value, paste only style, paste style from clipboard)
 */

if(!jspreadsheet&&"function"==typeof require)var jspreadsheet=require("jspreadsheet");if(!jSuites&&"function"==typeof require)var jSuites=require("jsuites");!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.jss_copypaste_advanced=t()}(this,function(){return function(e,t){if(8>parseInt(jspreadsheet.version().version.split(".")[0]))return console.error('Plugin "Copy paste advanced" not compatible with jspreadsheet '+jspreadsheet.version().version+", Please use an older version of this plugin compatible. Go to https://github.com/GBonnaire/jspreadsheet-plugins-and-editors/"),{};var s={},o=[],l=null,n=!1,r=null,a=!1,i={};i.options=Object.assign({},t);var p={allow_pastestyle:!0,text_paste_special:jSuites.translate("Paste special"),text_paste_only_style:jSuites.translate("Paste only format"),text_paste_only_value:jSuites.translate("Paste only values"),text_paste_only_formula:jSuites.translate("Paste only values and formulas"),text_transpose:jSuites.translate("Transpose"),text_paste_transpose:jSuites.translate("Format, formulas and values"),text_paste_transpose_only_value:jSuites.translate("Values only"),text_paste_transpose_only_formula:jSuites.translate("Formulas and values"),position_toolbar:null};for(var c in null==i.options&&(i.options={}),p)i.options.hasOwnProperty(c)&&null!=i.options[c]||(i.options[c]=p[c]);i.init=function(e){e.table.addEventListener("mousedown",function(){if(a){n&&(n=!1,$());var t,s=l[0],o=l[1];f(e,s,o,l[2],l[3])}}),e.element.addEventListener("mouseup",function(){l=e.selectedCell})},i.contextMenu=function(e,t,s,o,l,n,r,a){var p=!1,c=-1;for(var d in l){var u=l[d];if(u.title==jSuites.translate("Paste")){u.onclick=function(){e.selectedCell&&i.paste()},p=!0;break}u.title==jSuites.translate("Copy")&&(c=parseInt(d))}if(!p&&-1!=c&&(jspreadsheet.dataCopied||navigator&&navigator.clipboard)){var f={title:jSuites.translate("Paste"),icon:"content_paste",shortcut:"Ctrl + V",onclick:function(){e.selectedCell&&(i.options.allow_pastestyle?i.paste():i.pasteOnlyValue())}};l.splice(c+1,0,f)}if(i.options.allow_pastestyle&&-1!=c&&(jspreadsheet.styleCopied||navigator&&navigator.clipboard)){var y={title:i.options.text_paste_special,submenu:[{title:i.options.text_paste_only_value,onclick:function(){e.selectedCell&&i.pasteOnlyValue()}},{title:i.options.text_paste_only_formula,onclick:function(){e.selectedCell&&i.pasteOnlyValueAndFormula()}},{title:i.options.text_paste_only_style,onclick:function(){e.selectedCell&&i.pasteOnlyStyle()}},{title:i.options.text_transpose,submenu:[{title:i.options.text_paste_transpose,onclick:function(){e.selectedCell&&i.pasteTranspose()}},{title:i.options.text_paste_transpose_only_value,onclick:function(){e.selectedCell&&i.pasteTransposeOnlyValue()}},{title:i.options.text_paste_transpose_only_formula,onclick:function(){e.selectedCell&&i.pasteTransposeOnlyValueAndFormula()}}]}]};l.splice(c+2,0,y)}return l},i.topMenu=function(e,t,s,o){if("Edit"==e){var l=!1,n=-1;for(var r in t){var a=t[r];if(a.title==jSuites.translate("Paste")){a.onclick=function(){jspreadsheet.current.selectedCell&&i.paste()},l=!0;break}a.title==jSuites.translate("Copy")&&(n=parseInt(r))}if(!l&&-1!=n&&(jspreadsheet.dataCopied||navigator&&navigator.clipboard)){var p={title:jSuites.translate("Paste"),icon:"content_paste",shortcut:o+" V",onclick:function(){jspreadsheet.current.selectedCell&&(i.options.allow_pastestyle?i.paste():i.pasteOnlyValue())}};t.splice(n+1,0,p)}if(i.options.allow_pastestyle&&-1!=n&&(jspreadsheet.styleCopied||navigator&&navigator.clipboard)){var c={title:i.options.text_paste_special,submenu:[{title:i.options.text_paste_only_value,onclick:function(){jspreadsheet.current.selectedCell&&i.pasteOnlyValue()}},{title:i.options.text_paste_only_style,onclick:function(){jspreadsheet.current.selectedCell&&i.pasteOnlyStyle()}}]};t.splice(n+2,0,c)}}return t},i.toolbar=function(e){if(!1===i.options.position_toolbar)return e;var t={type:"i",content:"content_paste",onclick:function(){jspreadsheet.current.selectedCell&&i.paste()}},s={type:"i",content:"content_cut",onclick:function(){jspreadsheet.current.selectedCell&&jspreadsheet.current.copy(!0)}},o={type:"i",content:"content_copy",onclick:function(){jspreadsheet.current.selectedCell&&jspreadsheet.current.copy()}};if(null!==i.options.position_toolbar)e.items.splice(parseInt(i.options.position_toolbar),0,t),e.items.splice(parseInt(i.options.position_toolbar),0,o),e.items.splice(parseInt(i.options.position_toolbar),0,s);else for(var l in e.items)if("divisor"==e.items[l].type){e.items.splice(parseInt(l)+1,0,{type:"divisor"}),e.items.splice(parseInt(l)+1,0,t),e.items.splice(parseInt(l)+1,0,o),e.items.splice(parseInt(l)+1,0,s);break}return e},i.onevent=function(e,t){if("onselection"!=e||a||$(t),"onblur"==e&&(a=!1,$(t)),"oncopy"==e){n=!0;var s=arguments[2],l=parseInt(s[0]),p=parseInt(s[1]),c=parseInt(s[2]),d=parseInt(s[3]);if(o.length>0)arguments[1],h(t),f(t,l,p,c,d,!1),jspreadsheet.dataCopied=v(t),i.options.allow_pastestyle&&t.options.style?jspreadsheet.styleCopied=m(t):jspreadsheet.styleCopied=null;else if(jspreadsheet.dataCopied=arguments[3],i.options.allow_pastestyle&&t.options.style){for(var u=[],y=p;y<=d;y++){for(var b=[],j=l;j<=c;j++){var g=jspreadsheet.helpers.getColumnNameFromCoords(j,y);b.push(t.options.style[g])}u.push(b)}jspreadsheet.styleCopied=u}else jspreadsheet.styleCopied=null}if("onbeforepaste"==e&&null!=r&&"function"==typeof r){let C=r(arguments[2],!1,arguments[4],arguments[3]);return arguments[5].length>0&&r(arguments[5],!0,arguments[4],arguments[3]),r=null,C}"onpaste"==e&&h(t)},i.copy=function(e){let t=b();if(t)return t.copy(e)},i.paste=function(e,t=!0,s){null!=s&&"function"==typeof s&&(r=s),null==e&&(e=!i.options.allow_pastestyle);let l="";e&&jspreadsheet.clipboard.hash&&(l=jspreadsheet.clipboard.hash);let n=b();var a=parseInt(n.selectedCell[0]),p=parseInt(n.selectedCell[1]);if(t&&navigator&&navigator.clipboard&&navigator.clipboard.read&&0==o.length)navigator.clipboard.read().then(function(t){t[0].getType("text/plain").then(function(t){return new Response(t).text().then(function(t){if(e){var s=n.borders.copying;n.borders.copying=null,l&&(jspreadsheet.clipboard.hash=0)}if(t&&n.paste(a,p,t),e&&(n.borders.copying=s,l&&(jspreadsheet.clipboard.hash=l)),t)return!0})}),e||-1===t[0].types.indexOf("text/html")||t[0].getType("text/html").then(function(e){return new Response(e).text().then(function(e){d(e)})})}).catch(function(s){if(jspreadsheet.dataCopied&&e){let o=v(n,jspreadsheet.dataCopied,t,a,p);if(e){var r=n.borders.copying;n.borders.copying=null,l&&(jspreadsheet.clipboard.hash=0)}n.paste(a,p,j(o)),e&&(n.borders.copying=r,l&&(jspreadsheet.clipboard.hash=l))}e||n.borders.copying||!jspreadsheet.styleCopied||i.pasteOnlyStyle()});else if(jspreadsheet.dataCopied){let c=v(n,jspreadsheet.dataCopied,t,a,p);if(e){var u=n.borders.copying;n.borders.copying=null,l&&(jspreadsheet.clipboard.hash=0)}n.paste(a,p,j(c)),e&&(n.borders.copying=u,l&&(jspreadsheet.clipboard.hash=l)),!e&&jspreadsheet.styleCopied&&i.pasteOnlyStyle()}},i.pasteOnlyStyle=function(){var e=null;let t=b();if(t.borders.copying?e=m(t):navigator&&navigator.clipboard&&navigator.clipboard.read?navigator.clipboard.read().then(function(t){-1!==t[0].types.indexOf("text/html")?t[0].getType("text/html").then(function(e){return new Response(e).text().then(function(e){d(e)})}):e=jspreadsheet.styleCopied}):e=jspreadsheet.styleCopied,e){for(var s=parseInt(t.selectedCell[0]),o=parseInt(t.selectedCell[1]),l={},n=0;n<e.length;n++)for(var r=e[n],a=0;a<r.length;a++){var i=r[a];null!=i&&(l[jspreadsheet.helpers.getColumnNameFromCoords(s+a,o+n)]=i)}t.setStyle(l,null,null,!0)}},i.pasteOnlyValue=function(){i.paste(!0,!0)},i.pasteOnlyValueAndFormula=function(){i.paste(!0,!1)},i.pasteTranspose=function(e=!1,t=!0){i.paste(e,t,g)},i.pasteTransposeOnlyValue=function(){i.pasteTranspose(!0,!0)},i.pasteTransposeOnlyValueAndFormula=function(){i.pasteTranspose(!0,!1)};let d=function(e,t){if(null==t&&(t=b()),"string"==typeof e){var s=document.createElement("div");s.innerHTML=e,e=s}var o=e.querySelector("table"),l={};if(o){for(var n=parseInt(t.selectedCell[0]),r=parseInt(t.selectedCell[1]),a=e.querySelector("style"),i=o.querySelectorAll("tbody tr"),p=0;p<i.length;p++)for(var c=i[p].querySelectorAll("td"),d=0;d<c.length;d++){var f=c[d];if(a)var y=u(f,a.innerHTML);else var y=u(f,null);l[jspreadsheet.helpers.getColumnNameFromCoords(n+d,r+p)]=y}t.setStyle(l,null,null,!0)}},u=function(e,t){if(e.style.cssText)var s=e.style.cssText+";";else var s="";if(t)for(var o=0;o<e.classList.length;o++){var l=RegExp("\\."+e.classList[o]+"\\s*{([^}]+)}","gm").exec(t);l&&(s+=l=(l=l[1]).replace(/\s+/gm," "))}return s},f=function(e,t,o,l,n,r=!0){if(t===l&&o===n){var a=t,i=o;s[a+","+i]?($(e,s[a+","+i]),delete s[a+","+i]):r?s[a+","+i]=y(e,a,i,a,i):s[a+","+i]=null}else{var p=Math.min(t,l),c=Math.max(t,l),d=Math.min(o,n),u=Math.max(o,n);for(let f=p;f<=c;f++)for(let h=d;h<=u;h++)s[f+","+h]||(r?s[f+","+h]=y(e,f,h,f,h):s[f+","+h]=null)}},y=function(e,t,s,l,r){if(!n){void 0==e&&(e=b());var a=jspreadsheet.helpers.getColumnNameFromCoords(t,s);return(t!=l||s!=r)&&(a+=":"+jspreadsheet.helpers.getColumnNameFromCoords(l,r)),o.push("plugin.copypasteadv_"+a),e.setBorder(t,s,l,r,"plugin.copypasteadv_"+a),e.borders["plugin.copypasteadv_"+a].element.classList.add("jss_border_main"),e.borders["plugin.copypasteadv_"+a].color="",e.borders["plugin.copypasteadv_"+a].element.style.borderColor="",e.borders["plugin.copypasteadv_"+a].element.style.backgroundColor="",o.length-1}},h=function(e){for(let t=0;t<o.length;t++){let s=o[t];""!=s&&e.borders[s]&&(e.borders[s].element.classList.remove("jss_border_main"),e.borders[s].element.classList.add("jss_border_copying"))}},$=function(e,t,l){if(!n){if(void 0==e&&(e=b(),void 0==l&&(l=!0)),void 0==l&&(l=!1),l){for(let r in e.borders)-1!=r.indexOf("plugin.copypasteadv_")&&e.resetBorders(r,!0);e.resetBorders("copying",!0)}else{if(0==o.length)return;if(void 0!=t)""!=o[t]&&(e.resetBorders(o[t],!0),o[t]="");else{for(let a in o)e.resetBorders(o[a],!0);e.resetBorders("copying",!0)}}void 0==t&&(o=[],s={})}},b=function(){return jspreadsheet.current?jspreadsheet.current:null!=e.getWorksheetActive()?e.worksheets[e.getWorksheetActive()]:e.worksheets[0]},v=function(e,t,l,r,a){if("string"==typeof t&&(t=jspreadsheet.helpers.parseCSV(t,"	")),n&&o.length>0){let i=-1,p=-1,c=-1,d=-1;for(let u in s){let f=u.split(",");i=-1==i?parseInt(f[0]):Math.min(i,parseInt(f[0])),c=-1==c?parseInt(f[0]):Math.max(c,parseInt(f[0])),p=-1==p?parseInt(f[1]):Math.min(p,parseInt(f[1])),d=-1==d?parseInt(f[1]):Math.max(d,parseInt(f[1]))}let y=[];for(let h=p;h<=d;h++){let $=[];for(let b=i;b<=c;b++)t&&void 0!=r&&void 0!=a?l&&void 0!==s[b+","+h]?$.push(t[h-p][b-i]):$.push(e.getValueFromCoords(b-i+r,h-p+a,l)):void 0!==s[b+","+h]?$.push(e.getValueFromCoords(b,h,l)):$.push(null);y.push($)}return y}if(!n||!jspreadsheet.clipboard)return t;if(l)return jspreadsheet.clipboard.value;{let v=jspreadsheet.clipboard.selection[0],m=jspreadsheet.clipboard.selection[1],j=jspreadsheet.clipboard.selection[2],g=jspreadsheet.clipboard.selection[3],C=[];for(let _=m;_<=g;_++){let x=[];for(let S=v;S<=j;S++)x.push(e.getValueFromCoords(S,_,l));C.push(x)}return C}},m=function(e){if(!e.options.style)return null;if(n&&o.length>0){let t=0,l=0,r=0;for(let a in maxY=0,s){let i=a.split(",");t=Math.min(t,i[0]),r=Math.max(r,i[0]),l=Math.min(t,i[1]),r=Math.max(r,i[1])}let p=[];for(let c=l;c<=maxY;c++){let d=[];for(let u=t;u<=r;u++)if(void 0!==s[u+","+c]){let f=jspreadsheet.helpers.getColumnNameFromCoords(u,c);d.push(e.options.style[f])}else d.push(null);p.push(d)}return p}{let y=[e.borders.copying.x1,e.borders.copying.y1,e.borders.copying.x2,e.borders.copying.y2],h=parseInt(y[0]),$=parseInt(y[1]),b=parseInt(y[2]),v=parseInt(y[3]),m=[];for(let j=$;j<=v;j++){let g=[];for(let C=h;C<=b;C++){let _=jspreadsheet.helpers.getColumnNameFromCoords(C,j);g.push(e.options.style[_])}m.push(g)}return m}},j=function(e){if("string"==typeof e)return e;let t="";if("object"==typeof e&&Array.isArray(e))for(var s=0;s<e.length;s++)"object"==typeof e[s]&&Array.isArray(e[s])?t+=e[s].join("	")+"\r\n":t+=e[s]+"\r\n";return t.replace(RegExp('"',"g"),'""')},g=function(e,t=!0,s,o){let l=e.length,n=e[0].length,r=Math.max(n,l);for(let a=0;a<r;a++)for(let i=a+1;i<r;i++){let p=e[a][i];null==e[i]&&(e[i]=[]),t?(e[a][i]=e[i][a],e[i][a]=p):(e[a][i]=C(e[i][a],o+i,s+a),e[i][a]=C(p,o+a,s+i))}e.splice(n);for(let c=0;c<n;c++)e[c].splice(l);return e},C=function(e,t,s){return e&&"="==e.toString().substring(0,1)?e.replace(/([A-Z0-9]+[\!\.])?([A-Z]+[0-9]+(?:\:[A-Z]*[0-9]*)?)/gm,"#REF!"):e};if(i.options.allow_pastestyle){var _=jspreadsheet.events.paste;jspreadsheet.events.paste=function(e){if(_(e),jspreadsheet.current&&jspreadsheet.current.selectedCell&&!jspreadsheet.current.edition){if(e&&e.clipboardData&&e.clipboardData.types&&e.clipboardData.getData){if(e.clipboardData.types instanceof DOMStringList&&e.clipboardData.types.contains("text/html")||e.clipboardData.types.indexOf&&-1!==e.clipboardData.types.indexOf("text/html")){var t=e.clipboardData.getData("text/html");d(t)}}else if(window.clipboardData&&window.clipboardData.types&&window.clipboardData.getData){if(window.clipboardData.types instanceof DOMStringList&&window.clipboardData.types.contains("text/html")||window.clipboardData.types.indexOf&&-1!==window.clipboardData.types.indexOf("text/html")){var t=window.clipboardData.getData("text/html");d(t)}}else navigator&&navigator.clipboard&&navigator.clipboard.read&&navigator.clipboard.read().then(function(e){-1!==e[0].types.indexOf("text/html")&&e[0].getType("text/html").then(function(e){return new Response(e).text().then(function(e){d(e)})})})}}}return document.addEventListener("keydown",function(e){a=(e.ctrlKey||e.metaKey)&&!e.shiftKey,"Escape"==e.key&&!0==n&&(n=!1,$())}),document.addEventListener("keyup",function(e){a=(e.ctrlKey||e.metaKey)&&!e.shiftKey}),i}});