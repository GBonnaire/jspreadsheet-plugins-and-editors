/**
 * Plugin to add utils feature on jspreadsheet Pro
 * 
 * @version 1.4.0
 * @author Guillaume Bonnaire <contact@gbonnaire.fr>
 * @website https://repo.gbonnaire.fr
 * @description Plugin to add utils feature on jspreadsheet Pro like :
 *  - Move rows
 *  - Duplicate Row
 *  - Hide Sheet
 *  - Hide columns / show columns
 *  - Hide rows / show rows
 *  - Zoom
 *
 *  @event onzoom(worksheet: Object, zoomValue: int) dispatch on onevent in options of JSS
 * 
 * @license This plugin is distribute under MIT License
 * 
 * ReleaseNote :
 * 1.0 : Create plugin
 * 1.1 : Add zoom feature
 * 1.2 : Add hide / show row feature
 * 1.3 : Add show hidden rows and columns in 1 time
 * 1.4 : Replace default contextmenu
*/ if(!jSuites&&"function"==typeof require)var jSuites=require("jsuites");if(!jspreadsheet&&"function"==typeof require)var jspreadsheet=require("jspreadsheet");!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.jss_utils=t()}(this,function(){return function(e,t,o){let n={},i={};n.options=Object.assign({},t);let l={allow:{moveRow:!0,duplicateRow:!0,hideSheet:!0,hideColumn:!0,hideRow:!0,zoom:!0},icon:{moveUpRow:"arrow_upward",moveDownRow:"arrow_downward",duplicateRow:"content_copy",hideRow:"visibility_off",showRow:"visibility",showRows:"visibility",hideColumn:"visibility_off",showColumn:"visibility",showColumns:"visibility",hideWorksheet:"visibility_off"},text:{moveUpRow:jSuites.translate("Move up row(s) selected"),moveDownRow:jSuites.translate("Move down row(s) selected"),duplicateRow:jSuites.translate("Duplicate row(s) selected"),hideRow:jSuites.translate("Hide row(s) selected"),showRow:jSuites.translate("Show hidden row ({0})"),showRows:jSuites.translate("Show hidden rows"),hideColumn:jSuites.translate("Hide column(s) selected"),showColumn:jSuites.translate("Show hidden column ({0})"),showColumns:jSuites.translate("Show hidden columns"),hideWorksheet:jSuites.translate("Hide this worksheet")}};for(let s in null==n.options&&(n.options={}),l)if(n.options.hasOwnProperty(s)&&null!=n.options[s]){if("object"==typeof l[s]&&!Array.isArray(l[s]))for(let c in n.options[s])n.options[s].hasOwnProperty(c)&&null!=n.options[s][c]||(n.options[s][c]=l[s][c])}else n.options[s]=l[s];n.onevent=function(t,o){"onload"==t&&r.onload(e.element,e.element.tabs),"onresize"==t&&p.updateViewport(arguments[1],arguments[2]),("onopenworksheet"==t||"oncreateworksheet"==t)&&p.update(o)},n.toolbar=function(e){return e.items.push({type:"divisor"}),e.items.push({type:"i",content:"zoom_out",onclick:function(){p.out(10)}}),e.items.push({type:"label",content:"100%",id:"zoom_label",onclick:function(){let e=prompt(jSuites.translate("Set new zoom value"),p.get());p.set(e)},updateState(e,t,o,n){o.innerText=p.get(n)+"%"}}),e.items.push({type:"i",content:"zoom_in",onclick:function(){p.in(10)}}),e},n.contextMenu=function(t,o,i,l,s,c){var r,p,u,d;let h=a();if(null==o&&null!=i&&t.getSelectedRows(!0).length){let w=0;for(let f in s)if("divisor"==s[f].type||"line"==s[f].type){w=parseInt(f)+1;break}if(h.options.rowDrag&&n.options.allow.moveRow){let m={title:n.options.text.moveUpRow,onclick:function(){let e=t.getSelectedRows(!0);e.forEach(function(e){t.moveRow(e,e-1)});let o=t.options.data[0].length-1;t.updateSelectionFromCoords(0,Math.min(e),o,Math.max(e))}};n.options.icon.moveUpRow&&(m.icon=n.options.icon.moveUpRow),s.splice(w,0,m),w++;let g={title:n.options.text.moveDownRow,onclick:function(){let e=t.getSelectedRows(!0);e.reverse().forEach(function(e){t.moveRow(e,e+1)});let o=t.options.data[0].length-1;t.updateSelectionFromCoords(0,Math.min(e),o,Math.max(e))}};n.options.icon.moveDownRow&&(g.icon=n.options.icon.moveDownRow),s.splice(w,0,g),w++}if(h.options.editable&&n.options.allow.duplicateRow){let $={title:n.options.text.duplicateRow,onclick:function(){let e=t.getSelectedRows(!0),o=Math.max(e),n=t.getData(!0);n.forEach(function(e){t.insertRow(e,o),o++});let i=t.options.data[0].length-1,l=o;t.updateSelectionFromCoords(0,Math.min(e),i,l)}};n.options.icon.duplicateRow&&($.icon=n.options.icon.duplicateRow),s.splice(w,0,$),w++}if(n.options.allow.hideRow){let R=-1;for(let _ in s)if(s[_].title==jSuites.translate("Hide")){R=parseInt(_);break}let b={title:n.options.text.hideRow,onclick:function(){let e=t.getSelectedRows(!0);e.forEach(function(e){t.hideRow(e)})}};n.options.icon.hideRow&&(b.icon=n.options.icon.hideRow),-1==R?(s.splice(w,0,b),R=w):(s[R]=b,s[parseInt(R)+1].title==jSuites.translate("Show")&&s.splice(parseInt(R)+1,1)),R++;let v=Math.min(...t.getSelectedRows(!0)),y=Math.max(...t.getSelectedRows(!0)),S=t.getRow(v-1),C=t.getRow(y+1);if(S&&!1===S.visible){let k={title:n.options.text.showRow.replace("{0}",S.title?S.title:v+1-1),onclick:function(){t.showRow(v-1)}};n.options.icon.showRow&&(k.icon=n.options.icon.showRow),s.splice(R,0,k),R++}if(C&&!1===C.visible){let j={title:n.options.text.showRow.replace("{0}",C.title?C.title:y+1+1),onclick:function(){t.showRow(y+1)}};n.options.icon.showRow&&(j.icon=n.options.icon.showRow),s.splice(R,0,j),R++}if(v!=y){let x=!1;for(let z=v+1;z<y;z++){let O=t.getRow(z);if(!1==O.visible){x=!0;break}}if(x){let E={title:n.options.text.showRows,onclick:(r=v,p=y,function(){for(let e=r+1;e<p;e++){let o=t.getRow(e);!1==o.visible&&t.showRow(e)}})};n.options.icon.showRows&&(E.icon=n.options.icon.showRows),s.splice(R,0,E),R++}}}}else if(null==i&&null!=o&&t.getSelectedColumns().length){let H=0;for(let D in s)if(s[D].title===jSuites.translate("Insert a new column before")){H=parseInt(D);break}if(n.options.allow.hideColumn){let I=-1;for(let W in s)if(s[W].title==jSuites.translate("Hide")){I=parseInt(W);break}let P={title:n.options.text.hideColumn,onclick:function(){let e=t.getSelectedColumns();e.forEach(function(e){t.hideColumn(e)})}};n.options.icon.hideColumn&&(P.icon=n.options.icon.hideColumn),-1==I?(s.splice(H,0,P),I=H):(s[I]=P,s[parseInt(I)+1].title==jSuites.translate("Show")&&s.splice(parseInt(I)+1,1)),I++;let L=Math.min(...t.getSelectedColumns()),T=Math.max(...t.getSelectedColumns()),U=t.getColumn(L-1),F=t.getColumn(T+1);if(U&&!1===U.visible){let N={title:n.options.text.showColumn.replace("{0}",U.title?U.title:jspreadsheet.helpers.getColumnName(L-1)),onclick:function(){t.showColumn(L-1)}};n.options.icon.showColumn&&(N.icon=n.options.icon.showColumn),s.splice(I,0,N),I++}if(F&&!1===F.visible){let V={title:n.options.text.showColumn.replace("{0}",F.title?F.title:jspreadsheet.helpers.getColumnName(T+1)),onclick:function(){t.showColumn(T+1)}};n.options.icon.showColumn&&(V.icon=n.options.icon.showColumn),s.splice(I,0,V),I++}if(L!=T){let A=!1;for(let M=L+1;M<T;M++){let B=t.getColumn(M);if(!1==B.visible){A=!0;break}}if(A){let q={title:n.options.text.showColumns,onclick:(u=L,d=T,function(){for(let e=u+1;e<d;e++){let o=t.getColumn(e);!1==o.visible&&t.showColumn(e)}})};n.options.icon.showColumns&&(q.icon=n.options.icon.showColumns),s.splice(I,0,q),I++}}}}else if(null==o&&null==i&&"tabs"==c&&(Array.isArray(e.el.jspreadsheet)?e.el.jspreadsheet.length:1)>1&&n.options.allow.hideSheet){let G={title:n.options.text.hideWorksheet,onclick:function(){let t=e.el.tabs.headers.querySelector(".jtabs-selected");if(t){t.style.display="none";let o=Array.prototype.indexOf.call(e.el.tabs.headers.children,t),n=1,i=o;for(let l=0;l<=e.el.tabs.headers.children.length-2&&!((i+=n)<0);l++){let s=e.el.tabs.headers.children[i];if(s.classList.contains("jtabs-border"))n=-1,i=o;else if("none"!==s.style.display){e.el.tabs.open(i);break}}}}};n.options.icon.hideWorksheet&&(G.icon=n.options.icon.hideWorksheet),s.unshift(G)}return s},n.topMenu=function(e,t,o,i){if("Edit"===e){let l=a(),s=l;if(null!=l.selectedCell){if(t.push({type:"line"}),l.options.rowDrag){let c={title:n.options.text.moveUpRow,onclick:function(){let e=s.getSelectedRows(!0);e.forEach(function(e){s.moveRow(e,e-1)});let t=s.options.data[0].length-1;s.updateSelectionFromCoords(0,Math.min(e),t,Math.max(e))}};n.options.icon.moveUpRow&&(c.icon=n.options.icon.moveUpRow),t.push(c);let r={title:n.options.text.moveDownRow,onclick:function(){let e=s.getSelectedRows(!0);e.reverse().forEach(function(e){s.moveRow(e,e+1)});let t=s.options.data[0].length-1;s.updateSelectionFromCoords(0,Math.min(e),t,Math.max(e))}};n.options.icon.moveDownRow&&(r.icon=n.options.icon.moveDownRow),t.push(r)}let p={title:n.options.text.duplicateRow,onclick:function(){let e=s.getSelectedRows(!0),t=Math.max(e),o=s.getData(!0);o.forEach(function(e){s.insertRow(e,t),t++});let n=s.options.data[0].length-1,i=t;s.updateSelectionFromCoords(0,Math.min(e),n,i)}};n.options.icon.duplicateRow&&(p.icon=n.options.icon.duplicateRow),t.push(p)}}return t};let r=function(){let e={};return e.onload=function(e,t){let o=t.headers.parentNode,n=document.createElement("DIV");n.className="jss_contextmenu",e.appendChild(n);let i=jSuites.contextmenu(n,{onclick:function(){i.close()}}),l=document.createElement("DIV");l.classList.add("jtabs-menu"),l.style.cursor="pointer";let s=document.createElement("SPAN");s.classList.add("material-icons"),s.innerHTML="list",l.append(s),l.addEventListener("click",function(e){let o=e.target.getBoundingClientRect(),n=o.left,l=o.top+o.height,s=[];for(let c=0;c<t.headers.children.length;c++)if(!t.headers.children[c].classList.contains("jtabs-border")){let r=t.headers.children[c].querySelector(".material-icons"),p=null,a="";r?(p=r.innerText,a=t.headers.children[c].innerText.substring(p.length)):a=t.headers.children[c].innerText,"none"===t.headers.children[c].style.display&&(a+=" "+jSuites.translate("(hidden)")),s.push({title:a,icon:p,disabled:t.headers.children[c].classList.contains("jtabs-selected"),onclick:function(e){return function(){"none"===t.headers.children[e].style.display&&(t.headers.children[e].style.display=""),t.open(e)}}(c)})}t.options.allowCreate&&s.push({title:jSuites.translate("New tab"),icon:"add_box",onclick:function(){t.create()}}),i.open({x:n,y:l},s)}),o.insertBefore(l,o.firstChild)},e}(),p=function(){let t={};return t.init=function(e){null==e&&(e=a()),null==e.options.pluginOptions&&(e.options.pluginOptions={}),null!=e.options.pluginOptions.zoom||(e.options.pluginOptions.zoom={value:100},t.updateViewport(),e.options.tableOverflow||window.addEventListener("scroll",function(){let e=a(),t=p.get(e)/100;var o=document.body.scrollTop-document.body.scrollTop/t;for(let n of e.headerContainer.children)n.style.top=`${-o}px`}))},t.updateViewport=function(e,o,n){null==n&&(n=a()),t.init(n),null==e&&(e=parseInt(n.content.style.width?n.content.style.width:n.content.offsetWidth)),null==o&&(o=parseInt(n.content.style.height?n.content.style.height:n.content.style.offsetHeight)),n.options.pluginOptions.zoom.tableWidthInit=parseInt(e*t.get(n)/100),isNaN(n.options.pluginOptions.zoom.tableWidthInit)&&(n.options.pluginOptions.zoom.tableWidthInit=null),n.options.pluginOptions.zoom.tableHeightInit=parseInt(o*t.get(n)/100),isNaN(n.options.pluginOptions.zoom.tableHeightInit)&&(n.options.pluginOptions.zoom.tableHeightInit=null)},t.update=function(e){null==e&&(e=a()),t.init(e);let o=e.options.pluginOptions.zoom.tableHeightInit/(t.get(e)/100);e.content.style.marginBottom=`${e.options.pluginOptions.zoom.tableHeightInit-parseInt(o)}px`},t.set=function(o,n){if(isNaN(parseInt(o)))return;null==n&&(n=a());let i=Math.max(10,Math.min(200,parseInt(o)));if(n){n.content.style.transform="scale("+i/100+")",n.content.style.transformOrigin="top left",t.init(n),n.options.pluginOptions.zoom.value=i;let l=n.options.pluginOptions.zoom.tableWidthInit/(i/100),s=n.options.pluginOptions.zoom.tableHeightInit/(i/100);n.content.style.marginBottom=`${n.options.pluginOptions.zoom.tableHeightInit-parseInt(s)}px`,n.options.tableOverflow?(u(),n.setViewport(parseInt(l),parseInt(s)),d()):e.toolbar.querySelector("#zoom_label").innerText=i+"%",t.update(n),n.dispatch("onzoom",n,i)}},t.get=function(e){return null==e&&(e=a()),t.init(e),e.options.pluginOptions.zoom.value},t.in=function(e,o){this.set(t.get()+e,o)},t.out=function(e,o){this.set(t.get()-e,o)},t}();function a(){return jspreadsheet.current?jspreadsheet.current:null!=e.getWorksheetActive()?e.worksheets[e.getWorksheetActive()]:e.worksheets[0]}let u=function(){null==i.ignoreEvents&&(i.ignoreEvents=e.ignoreEvents),e.ignoreEvents=!0,null==i.ignoreCloud&&(i.ignoreCloud=e.ignoreCloud),null==i.ignoreHistory&&(i.ignoreHistory=e.ignoreHistory),e.ignoreHistory=!0,null==i.ignorePersistence&&(i.ignorePersistence=e.ignorePersistence),e.ignorePersistence=!0},d=function(){e.ignoreEvents=i.ignoreEvents,e.ignoreHistory=i.ignoreHistory,e.ignorePersistence=i.ignorePersistence,e.ignoreCloud=i.ignoreCloud,i={}};return n}});