/**
 * Plugin copy paste advance for jSpreadsheet
 * 
 * @version 3.0.4
 * @author Guillaume Bonnaire <contact@gbonnaire.fr>
 * @website https://repo.gbonnaire.fr
 * @description upgrade copy paste function for work with clipboard permission denied or error
 * and add button on toolbar copy/cut/paste
 * 
 * @license This plugin is distribute under MIT License
 * 
 * ReleaseNote
 * 3.0.0 : version for v8
 * 2.1.0 : add topmenu compatibility
 * 2.0.1 : transform jexcel to jspreadsheet
 * 2.0.0 : compatibility NPM + add special paste (paste only value, paste only style, paste style from clipboard)
*/ 
if(!jSuites&&"function"==typeof require)var jSuites=require("jsuites");!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.jss_copypaste_advanced=t()}(this,function(){return function(e,t){let n=this;if(!n)throw Error("JSpreadsheet must loaded before");if(8>parseInt(n.version().version.split(".")[0]))return console.error('Plugin "Copy paste advanced" not compatible with jspreadsheet '+n.version().version+", Please use an older version of this plugin compatible. Go to https://github.com/GBonnaire/jspreadsheet-plugins-and-editors/"),{};var o={};o.options=Object.assign({},t);var l={allow_pastestyle:!0,text_paste_special:jSuites.translate("Paste special"),text_paste_only_style:jSuites.translate("Paste only format"),text_paste_only_value:jSuites.translate("Paste only value")};for(var r in null==o.options&&(o.options={}),l)o.options.hasOwnProperty(r)&&null!=o.options[r]||(o.options[r]=l[r]);function s(e,t){if(null==t&&(t=n.current),"string"==typeof e){var o=document.createElement("div");o.innerHTML=e,e=o}var l=e.querySelector("table"),r={};if(l){for(var s=parseInt(n.current.selectedCell[0]),i=parseInt(n.current.selectedCell[1]),c=e.querySelector("style"),p=l.querySelectorAll("tbody tr"),u=0;u<p.length;u++)for(var y=p[u].querySelectorAll("td"),d=0;d<y.length;d++){var f=y[d];if(c)var v=a(f,c.innerHTML);else var v=a(f,null);r[n.helpers.getColumnNameFromCoords(s+d,i+u)]=v}t.setStyle(r,null,null,!0)}}function a(e,t){if(e.style.cssText)var n=e.style.cssText+";";else var n="";if(t)for(var o=0;o<e.classList.length;o++){var l=RegExp("\\."+e.classList[o]+"\\s*{([^}]+)}","gm").exec(t);l&&(n+=l=(l=l[1]).replace(/\s+/gm," "))}return n}if(o.init=function(e){},o.contextMenu=function(e,t,l,r,s,a,i,c){var p=!1,u=-1;for(var y in s){var d=s[y];if(d.title==jSuites.translate("Paste")){d.onclick=function(){e.selectedCell&&o.paste()},p=!0;break}d.title==jSuites.translate("Copy")&&(u=parseInt(y))}if(!p&&-1!=u&&(n.dataCopied||navigator&&navigator.clipboard)){var f={title:jSuites.translate("Paste"),icon:"content_paste",shortcut:"Ctrl + V",onclick:function(){e.selectedCell&&(o.options.allow_pastestyle?o.paste():o.pasteOnlyValue())}};s.splice(u+1,0,f)}if(o.options.allow_pastestyle&&-1!=u&&(n.styleCopied||navigator&&navigator.clipboard)){var v={title:o.options.text_paste_special,submenu:[{title:o.options.text_paste_only_value,onclick:function(){e.selectedCell&&o.pasteOnlyValue()}},{title:o.options.text_paste_only_style,onclick:function(){e.selectedCell&&o.pasteOnlyStyle()}}]};s.splice(u+2,0,v)}return s},o.topMenu=function(e,t,l,r){if("Edit"==e){var s=!1,a=-1;for(var i in t){var c=t[i];if(c.title==jSuites.translate("Paste")){c.onclick=function(){n.current.selectedCell&&o.paste()},s=!0;break}c.title==jSuites.translate("Copy")&&(a=parseInt(i))}if(!s&&-1!=a&&(n.dataCopied||navigator&&navigator.clipboard)){var p={title:jSuites.translate("Paste"),icon:"content_paste",shortcut:r+" V",onclick:function(){n.current.selectedCell&&(o.options.allow_pastestyle?o.paste():o.pasteOnlyValue())}};t.splice(a+1,0,p)}if(o.options.allow_pastestyle&&-1!=a&&(n.styleCopied||navigator&&navigator.clipboard)){var u={title:o.options.text_paste_special,submenu:[{title:o.options.text_paste_only_value,onclick:function(){n.current.selectedCell&&o.pasteOnlyValue()}},{title:o.options.text_paste_only_style,onclick:function(){n.current.selectedCell&&o.pasteOnlyStyle()}}]};t.splice(a+2,0,u)}}return t},o.toolbar=function(e){var t={type:"i",content:"content_paste",onclick:function(){n.current.selectedCell&&o.paste()}},l={type:"i",content:"content_cut",onclick:function(){n.current.selectedCell&&n.current.copy(!0)}},r={type:"i",content:"content_copy",onclick:function(){n.current.selectedCell&&n.current.copy()}};for(var s in e.items)if("redo"==e.items[s].content){e.items.splice(parseInt(s)+1,0,t),e.items.splice(parseInt(s)+1,0,r),e.items.splice(parseInt(s)+1,0,l);break}return e},o.onevent=function(e){if("oncopy"==e){n.dataCopied=arguments[3];var t=arguments[1],l=arguments[2];if(o.options.allow_pastestyle&&t.options.style){for(var r=parseInt(l[0]),s=parseInt(l[1]),a=parseInt(l[2]),i=parseInt(l[3]),c=[],p=s;p<=i;p++){for(var u=[],y=r;y<=a;y++){var d=n.helpers.getColumnNameFromCoords(y,p);u.push(t.options.style[d])}c.push(u)}n.styleCopied=c}else n.styleCopied=null}},o.copy=function(e){if(n.current)return n.current.copy(e)},o.paste=function(e){null==e&&(e=!1);var t=parseInt(n.current.selectedCell[0]),l=parseInt(n.current.selectedCell[1]);if(navigator&&navigator.clipboard)navigator.clipboard.read().then(function(r){r[0].getType("text/plain").then(function(r){return new Response(r).text().then(function(r){if(e||!o.options.allow_pastestyle){var s=n.current.borders.copying;n.current.borders.copying=null}r&&n.current.paste(t,l,r),(e||!o.options.allow_pastestyle)&&(n.current.borders.copying=s)})}),o.options.allow_pastestyle&&!e&&r[0].getType("text/html").then(function(e){return new Response(e).text().then(function(e){s(e)})})}).catch(function(r){if(n.dataCopied){if(e||!o.options.allow_pastestyle){var s=n.current.borders.copying;n.current.borders.copying=null}n.current.paste(t,l,n.dataCopied),(e||!o.options.allow_pastestyle)&&(n.current.borders.copying=s)}o.options.allow_pastestyle&&!e&&!n.current.borders.copying&&n.styleCopied&&o.pasteOnlyStyle()});else if(n.dataCopied){if(e||!o.options.allow_pastestyle){var r=n.current.borders.copying;n.current.borders.copying=null}n.current.paste(t,l,n.dataCopied),(e||!o.options.allow_pastestyle)&&(n.current.borders.copying=r),o.options.allow_pastestyle&&!e&&!n.current.borders.copying&&n.styleCopied&&o.pasteOnlyStyle()}},o.pasteOnlyStyle=function(){var e=null;if(n.current.borders.copying){var t=[n.current.borders.copying.x1,n.current.borders.copying.y1,n.current.borders.copying.x2,n.current.borders.copying.y2];if(n.current.options.style){for(var o=parseInt(t[0]),l=parseInt(t[1]),r=parseInt(t[2]),a=parseInt(t[3]),i=[],c=l;c<=a;c++){for(var p=[],u=o;u<=r;u++){var y=n.helpers.getColumnNameFromCoords(u,c);p.push(n.current.options.style[y])}i.push(p)}e=i}}else navigator&&navigator.clipboard?navigator.clipboard.read().then(function(e){e[0].getType("text/html").then(function(e){return new Response(e).text().then(function(e){s(e)})})}):e=n.styleCopied;if(e){for(var u=parseInt(n.current.selectedCell[0]),c=parseInt(n.current.selectedCell[1]),d={},f=0;f<e.length;f++)for(var p=e[f],v=0;v<p.length;v++){var i=p[v],y=n.helpers.getColumnNameFromCoords(u+v,c+f);d[y]=i}n.current.setStyle(d,null,null,!0)}},o.pasteOnlyValue=function(){o.paste(!0)},o.options.allow_pastestyle){var i=n.events.paste;n.events.paste=function(e){if(i(e),n.current&&n.current.selectedCell&&!n.current.edition){if(e&&e.clipboardData&&e.clipboardData.types&&e.clipboardData.getData){if(e.clipboardData.types instanceof DOMStringList&&e.clipboardData.types.contains("text/html")||e.clipboardData.types.indexOf&&-1!==e.clipboardData.types.indexOf("text/html")){var t=e.clipboardData.getData("text/html");s(t)}}else if(window.clipboardData&&window.clipboardData.types&&window.clipboardData.getData){if(window.clipboardData.types instanceof DOMStringList&&window.clipboardData.types.contains("text/html")||window.clipboardData.types.indexOf&&-1!==window.clipboardData.types.indexOf("text/html")){var t=window.clipboardData.getData("text/html");s(t)}}else navigator&&navigator.clipboard&&navigator.clipboard.read().then(function(e){e[0].getType("text/html").then(function(e){return new Response(e).text().then(function(e){s(e)})})})}}}return o}});