/**
 * Plugin copy paste advance for jSpreadsheet
 *
 * @version 3.2.0
 * @author Guillaume Bonnaire <contact@gbonnaire.fr>
 * @website https://repo.gbonnaire.fr
 * @description upgrade copy paste function for work with clipboard permission denied or error
 * and add button on toolbar copy/cut/paste
 *
 * @license This plugin is distribute under MIT License
 *
 * ReleaseNote
 * 3.1.0 : Migration V10, Select several cells and copy & paste (same relative position/as row/as column)
 * 3.0.0 : version for v8 and v9
 * 2.1.0 : add topmenu compatibility
 * 2.0.1 : transform jexcel to jspreadsheet
 * 2.0.0 : compatibility NPM + add special paste (paste only value, paste only style, paste style from clipboard)
 */
if(!jspreadsheet&&"function"==typeof require)var jspreadsheet=require("jspreadsheet");if(!jSuites&&"function"==typeof require)var jSuites=require("jsuites");!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.jss_copypaste_advanced=t()}(this,function(){return function(e,t){if(8>parseInt(jspreadsheet.version().version.split(".")[0]))return console.error('Plugin "Copy paste advanced" not compatible with jspreadsheet '+jspreadsheet.version().version+", Please use an older version of this plugin compatible. Go to https://github.com/GBonnaire/jspreadsheet-plugins-and-editors/"),{};var s={},o=[],l=null,n=!1,r=!1,a={};a.options=Object.assign({},t);var i={allow_pastestyle:!0,text_paste_special:jSuites.translate("Paste special"),text_paste_only_style:jSuites.translate("Paste only format"),text_paste_only_value:jSuites.translate("Paste only value"),text_paste_as_column:jSuites.translate("Paste as column"),text_paste_as_row:jSuites.translate("Paste as row"),position_toolbar:null};for(var p in null==a.options&&(a.options={}),i)a.options.hasOwnProperty(p)&&null!=a.options[p]||(a.options[p]=i[p]);a.init=function(e){e.table.addEventListener("mousedown",function(){if(r){n&&(n=!1,h());var t,s=l[0],o=l[1];u(e,s,o,l[2],l[3])}}),e.element.addEventListener("mouseup",function(){l=e.selectedCell})},a.contextMenu=function(e,t,s,o,l,n,r,i){var p=!1,c=-1;for(var d in l){var u=l[d];if(u.title==jSuites.translate("Paste")){u.onclick=function(){e.selectedCell&&a.paste()},p=!0;break}u.title==jSuites.translate("Copy")&&(c=parseInt(d))}if(!p&&-1!=c&&(jspreadsheet.dataCopied||navigator&&navigator.clipboard)){var f={title:jSuites.translate("Paste"),icon:"content_paste",shortcut:"Ctrl + V",onclick:function(){e.selectedCell&&(a.options.allow_pastestyle?a.paste():a.pasteOnlyValue())}};l.splice(c+1,0,f)}if(a.options.allow_pastestyle&&-1!=c&&(jspreadsheet.styleCopied||navigator&&navigator.clipboard)){var y={title:a.options.text_paste_special,submenu:[{title:a.options.text_paste_only_value,onclick:function(){e.selectedCell&&a.pasteOnlyValue()}},{title:a.options.text_paste_only_style,onclick:function(){e.selectedCell&&a.pasteOnlyStyle()}}]};l.splice(c+2,0,y)}return l},a.topMenu=function(e,t,s,o){if("Edit"==e){var l=!1,n=-1;for(var r in t){var i=t[r];if(i.title==jSuites.translate("Paste")){i.onclick=function(){jspreadsheet.current.selectedCell&&a.paste()},l=!0;break}i.title==jSuites.translate("Copy")&&(n=parseInt(r))}if(!l&&-1!=n&&(jspreadsheet.dataCopied||navigator&&navigator.clipboard)){var p={title:jSuites.translate("Paste"),icon:"content_paste",shortcut:o+" V",onclick:function(){jspreadsheet.current.selectedCell&&(a.options.allow_pastestyle?a.paste():a.pasteOnlyValue())}};t.splice(n+1,0,p)}if(a.options.allow_pastestyle&&-1!=n&&(jspreadsheet.styleCopied||navigator&&navigator.clipboard)){var c={title:a.options.text_paste_special,submenu:[{title:a.options.text_paste_only_value,onclick:function(){jspreadsheet.current.selectedCell&&a.pasteOnlyValue()}},{title:a.options.text_paste_only_style,onclick:function(){jspreadsheet.current.selectedCell&&a.pasteOnlyStyle()}}]};t.splice(n+2,0,c)}}return t},a.toolbar=function(e){if(!1===a.options.position_toolbar)return e;var t={type:"i",content:"content_paste",onclick:function(){jspreadsheet.current.selectedCell&&a.paste()}},s={type:"i",content:"content_cut",onclick:function(){jspreadsheet.current.selectedCell&&jspreadsheet.current.copy(!0)}},o={type:"i",content:"content_copy",onclick:function(){jspreadsheet.current.selectedCell&&jspreadsheet.current.copy()}};if(null!==a.options.position_toolbar)e.items.splice(parseInt(a.options.position_toolbar),0,t),e.items.splice(parseInt(a.options.position_toolbar),0,o),e.items.splice(parseInt(a.options.position_toolbar),0,s);else for(var l in e.items)if("divisor"==e.items[l].type){e.items.splice(parseInt(l)+1,0,{type:"divisor"}),e.items.splice(parseInt(l)+1,0,t),e.items.splice(parseInt(l)+1,0,o),e.items.splice(parseInt(l)+1,0,s);break}return e},a.onevent=function(e,t){if("onselection"!=e||r||h(t),"onblur"==e&&(r=!1,h(t)),"oncopy"==e){n=!0;var s=arguments[2],l=parseInt(s[0]),i=parseInt(s[1]),p=parseInt(s[2]),c=parseInt(s[3]);if(o.length>0)arguments[1],y(t),u(t,l,i,p,c,!1),jspreadsheet.dataCopied=b(t),a.options.allow_pastestyle&&t.options.style?jspreadsheet.styleCopied=m(t):jspreadsheet.styleCopied=null;else if(jspreadsheet.dataCopied=arguments[3],a.options.allow_pastestyle&&t.options.style){for(var d=[],f=i;f<=c;f++){for(var v=[],$=l;$<=p;$++){var j=jspreadsheet.helpers.getColumnNameFromCoords($,f);v.push(t.options.style[j])}d.push(v)}jspreadsheet.styleCopied=d}else jspreadsheet.styleCopied=null}"onpaste"==e&&y(t)},a.copy=function(e){let t=v();if(t)return t.copy(e)},a.paste=function(e){null==e&&(e=!a.options.allow_pastestyle);let t="";e&&jspreadsheet.clipboard.hash&&(t=jspreadsheet.clipboard.hash);let s=v();var l=parseInt(s.selectedCell[0]),n=parseInt(s.selectedCell[1]);if(console.log(o),navigator&&navigator.clipboard&&0==o.length)navigator.clipboard.read().then(function(o){o[0].getType("text/plain").then(function(o){return new Response(o).text().then(function(o){if(e){var r=s.borders.copying;s.borders.copying=null,t&&(jspreadsheet.clipboard.hash=0)}if(o&&s.paste(l,n,o),e&&(s.borders.copying=r,t&&(jspreadsheet.clipboard.hash=t)),o)return!0})}),e||-1===o[0].types.indexOf("text/html")||o[0].getType("text/html").then(function(e){return new Response(e).text().then(function(e){c(e)})})}).catch(function(t){if(jspreadsheet.dataCopied&&e){let o=b(s,jspreadsheet.dataCopied,l,n);if(e){var r=s.borders.copying;s.borders.copying=null}s.paste(l,n,$(o)),e&&(s.borders.copying=r)}e||s.borders.copying||!jspreadsheet.styleCopied||a.pasteOnlyStyle()});else if(jspreadsheet.dataCopied){let r=b(s,jspreadsheet.dataCopied,l,n);if(e){var i=s.borders.copying;s.borders.copying=null}s.paste(l,n,$(r)),e&&(s.borders.copying=i),!e&&jspreadsheet.styleCopied&&a.pasteOnlyStyle()}},a.pasteOnlyStyle=function(){var e=null;let t=v();if(t.borders.copying?e=m(t):navigator&&navigator.clipboard?navigator.clipboard.read().then(function(t){-1!==t[0].types.indexOf("text/html")?t[0].getType("text/html").then(function(e){return new Response(e).text().then(function(e){c(e)})}):e=jspreadsheet.styleCopied}):e=jspreadsheet.styleCopied,e){for(var s=parseInt(t.selectedCell[0]),o=parseInt(t.selectedCell[1]),l={},n=0;n<e.length;n++)for(var r=e[n],a=0;a<r.length;a++){var i=r[a];null!=i&&(l[jspreadsheet.helpers.getColumnNameFromCoords(s+a,o+n)]=i)}t.setStyle(l,null,null,!0)}},a.pasteOnlyValue=function(){a.paste(!0)};let c=function(e,t){if(null==t&&(t=v()),"string"==typeof e){var s=document.createElement("div");s.innerHTML=e,e=s}var o=e.querySelector("table"),l={};if(o){for(var n=parseInt(t.selectedCell[0]),r=parseInt(t.selectedCell[1]),a=e.querySelector("style"),i=o.querySelectorAll("tbody tr"),p=0;p<i.length;p++)for(var c=i[p].querySelectorAll("td"),u=0;u<c.length;u++){var f=c[u];if(a)var y=d(f,a.innerHTML);else var y=d(f,null);l[jspreadsheet.helpers.getColumnNameFromCoords(n+u,r+p)]=y}t.setStyle(l,null,null,!0)}},d=function(e,t){if(e.style.cssText)var s=e.style.cssText+";";else var s="";if(t)for(var o=0;o<e.classList.length;o++){var l=RegExp("\\."+e.classList[o]+"\\s*{([^}]+)}","gm").exec(t);l&&(s+=l=(l=l[1]).replace(/\s+/gm," "))}return s},u=function(e,t,o,l,n,r=!0){if(t===l&&o===n){var a=t,i=o;s[a+","+i]?(h(e,s[a+","+i]),delete s[a+","+i]):r?s[a+","+i]=f(e,a,i,a,i):s[a+","+i]=null}else{var p=Math.min(t,l),c=Math.max(t,l),d=Math.min(o,n),u=Math.max(o,n);for(let y=p;y<=c;y++)for(let v=d;v<=u;v++)s[y+","+v]||(r?s[y+","+v]=f(e,y,v,y,v):s[y+","+v]=null)}},f=function(e,t,s,l,r){if(!n){void 0==e&&(e=v());var a=jspreadsheet.helpers.getColumnNameFromCoords(t,s);return(t!=l||s!=r)&&(a+=":"+jspreadsheet.helpers.getColumnNameFromCoords(l,r)),o.push("plugin.copypasteadv_"+a),e.setBorder(t,s,l,r,"plugin.copypasteadv_"+a),e.borders["plugin.copypasteadv_"+a].element.classList.add("jss_border_main"),e.borders["plugin.copypasteadv_"+a].color="",e.borders["plugin.copypasteadv_"+a].element.style.borderColor="",e.borders["plugin.copypasteadv_"+a].element.style.backgroundColor="",o.length-1}},y=function(e){for(let t=0;t<o.length;t++){let s=o[t];""!=s&&e.borders[s]&&(e.borders[s].element.classList.remove("jss_border_main"),e.borders[s].element.classList.add("jss_border_copying"))}},h=function(e,t,l){if(!n){if(void 0==e&&(e=v(),void 0==l&&(l=!0)),void 0==l&&(l=!1),l){for(let r in e.borders)-1!=r.indexOf("plugin.copypasteadv_")&&e.resetBorders(r,!0);e.resetBorders("copying",!0)}else{if(0==o.length)return;if(void 0!=t)""!=o[t]&&(e.resetBorders(o[t],!0),o[t]="");else{for(let a in o)e.resetBorders(o[a],!0);e.resetBorders("copying",!0)}}void 0==t&&(o=[],s={})}},v=function(){return jspreadsheet.current?jspreadsheet.current:null!=e.getWorksheetActive()?e.worksheets[e.getWorksheetActive()]:e.worksheets[0]},b=function(e,t,l,r){if("string"==typeof t&&(t=jspreadsheet.helpers.parseCSV(t,"	")),!n||!(o.length>0))return t;{let a=-1,i=-1,p=-1,c=-1;for(let d in s){let u=d.split(",");a=-1==a?parseInt(u[0]):Math.min(a,parseInt(u[0])),p=-1==p?parseInt(u[0]):Math.max(p,parseInt(u[0])),i=-1==i?parseInt(u[1]):Math.min(i,parseInt(u[1])),c=-1==c?parseInt(u[1]):Math.max(c,parseInt(u[1]))}let f=[];for(let y=i;y<=c;y++){let h=[];for(let v=a;v<=p;v++)t&&void 0!=l&&void 0!=r?void 0!==s[v+","+y]?h.push(t[y-i][v-a]):h.push(e.getValueFromCoords(v-a+l,y-i+r)):void 0!==s[v+","+y]?h.push(e.getValueFromCoords(v,y)):h.push(null);f.push(h)}return f}},m=function(e){if(!e.options.style)return null;if(n&&o.length>0){let t=0,l=0,r=0;for(let a in maxY=0,s){let i=a.split(",");t=Math.min(t,i[0]),r=Math.max(r,i[0]),l=Math.min(t,i[1]),r=Math.max(r,i[1])}let p=[];for(let c=l;c<=maxY;c++){let d=[];for(let u=t;u<=r;u++)if(void 0!==s[u+","+c]){let f=jspreadsheet.helpers.getColumnNameFromCoords(u,c);d.push(e.options.style[f])}else d.push(null);p.push(d)}return p}{let y=[e.borders.copying.x1,e.borders.copying.y1,e.borders.copying.x2,e.borders.copying.y2],h=parseInt(y[0]),v=parseInt(y[1]),b=parseInt(y[2]),m=parseInt(y[3]),$=[];for(let j=v;j<=m;j++){let g=[];for(let C=h;C<=b;C++){let _=jspreadsheet.helpers.getColumnNameFromCoords(C,j);g.push(e.options.style[_])}$.push(g)}return $}},$=function(e){let t="";if("object"==typeof e&&Array.isArray(e))for(var s=0;s<e.length;s++)"object"==typeof e[s]&&Array.isArray(e[s])?t+=e[s].join("	")+"\r\n":t+=e[s]+"\r\n";return t.replace(RegExp('"',"g"),'""')};if(a.options.allow_pastestyle){var j=jspreadsheet.events.paste;jspreadsheet.events.paste=function(e){if(j(e),jspreadsheet.current&&jspreadsheet.current.selectedCell&&!jspreadsheet.current.edition){if(e&&e.clipboardData&&e.clipboardData.types&&e.clipboardData.getData){if(e.clipboardData.types instanceof DOMStringList&&e.clipboardData.types.contains("text/html")||e.clipboardData.types.indexOf&&-1!==e.clipboardData.types.indexOf("text/html")){var t=e.clipboardData.getData("text/html");c(t)}}else if(window.clipboardData&&window.clipboardData.types&&window.clipboardData.getData){if(window.clipboardData.types instanceof DOMStringList&&window.clipboardData.types.contains("text/html")||window.clipboardData.types.indexOf&&-1!==window.clipboardData.types.indexOf("text/html")){var t=window.clipboardData.getData("text/html");c(t)}}else navigator&&navigator.clipboard&&navigator.clipboard.read&&navigator.clipboard.read().then(function(e){-1!==e[0].types.indexOf("text/html")&&e[0].getType("text/html").then(function(e){return new Response(e).text().then(function(e){c(e)})})})}}}return document.addEventListener("keydown",function(e){r=(e.ctrlKey||e.metaKey)&&!e.shiftKey,"Escape"==e.key&&!0==n&&(n=!1,h())}),document.addEventListener("keyup",function(e){r=(e.ctrlKey||e.metaKey)&&!e.shiftKey}),a}});