/**
 * Plugin copy paste advance for jSpreadsheet
 * 
 * @version 3.0.3
 * @author Guillaume Bonnaire <contact@gbonnaire.fr>
 * @website https://repo.gbonnaire.fr
 * @description upgrade copy paste function for work with clipboard permission denied or error
 * and add button on toolbar copy/cut/paste
 * 
 * @license This plugin is distribute under MIT License
 * 
 * ReleaseNote
 * 3.0.0 : version for v8
 * 2.1.0 : add topmenu compatibility
 * 2.0.1 : transform jexcel to jspreadsheet
 * 2.0.0 : compatibility NPM + add special paste (paste only value, paste only style, paste style from clipboard)
 */
if(!jSuites&&"function"==typeof require)var jSuites=require("jsuites");!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.jss_copypaste_advanced=t()}(this,(function(){return function(e,t){const n=this;if(!n)throw new Error("JSpreadsheet must loaded before");if(parseInt(n.version().version.split(".")[0])<8)return console.error('Plugin "Copy paste advanced" not compatible with jspreadsheet '+n.version().version+", Please use an older version of this plugin compatible. Go to https://github.com/GBonnaire/jspreadsheet-plugins-and-editors/"),{};var o={};o.options=Object.assign({},t);var r={allow_pastestyle:!0,text_paste_special:jSuites.translate("Paste special"),text_paste_only_style:jSuites.translate("Paste only format"),text_paste_only_value:jSuites.translate("Paste only value")};for(var a in null==o.options&&(o.options={}),r)o.options.hasOwnProperty(a)&&null!=o.options[a]||(o.options[a]=r[a]);function s(e,t){if(null==t&&(t=n.current),"string"==typeof e){var o=document.createElement("div");o.innerHTML=e,e=o}var r=e.querySelector("table"),a={};if(r){for(var s=parseInt(n.current.selectedCell[0]),i=parseInt(n.current.selectedCell[1]),p=e.querySelector("style"),c=r.querySelectorAll("tbody tr"),u=0;u<c.length;u++)for(var d=c[u].querySelectorAll("td"),y=0;y<d.length;y++){var f=d[y];if(p)var v=l(f,p.innerHTML);else v=l(f,null);a[n.helpers.getColumnNameFromCoords(s+y,i+u)]=v}t.setStyle(a,null,null,!0)}}function l(e,t){if(e.style.cssText)var n=e.style.cssText+";";else n="";if(t)for(var o=0;o<e.classList.length;o++){var r=e.classList[o],a=new RegExp("\\."+r+"\\s*{([^}]+)}","gm").exec(t);a&&(n+=a=(a=a[1]).replace(/\s+/gm," "))}return n}if(o.init=function(e){},o.contextMenu=function(e,t,r,a,s,l,i,p){var c=!1,u=-1;for(var d in s){var y=s[d];if(y.title==jSuites.translate("Paste")){y.onclick=function(){e.selectedCell&&o.paste()},c=!0;break}y.title==jSuites.translate("Copy")&&(u=parseInt(d))}if(!c&&-1!=u&&(n.dataCopied||navigator&&navigator.clipboard)){var f={title:jSuites.translate("Paste"),icon:"content_paste",shortcut:"Ctrl + V",onclick:function(){e.selectedCell&&(o.options.allow_pastestyle?o.paste():o.pasteOnlyValue())}};s.splice(u+1,0,f)}if(o.options.allow_pastestyle&&-1!=u&&(n.styleCopied||navigator&&navigator.clipboard)){var v={title:o.options.text_paste_special,submenu:[{title:o.options.text_paste_only_value,onclick:function(){e.selectedCell&&o.pasteOnlyValue()}},{title:o.options.text_paste_only_style,onclick:function(){e.selectedCell&&o.pasteOnlyStyle()}}]};s.splice(u+2,0,v)}return s},o.topMenu=function(e,t,r,a){if("Edit"==e){var s=!1,l=-1;for(var i in t){var p=t[i];if(p.title==jSuites.translate("Paste")){p.onclick=function(){n.current.selectedCell&&o.paste()},s=!0;break}p.title==jSuites.translate("Copy")&&(l=parseInt(i))}if(!s&&-1!=l&&(n.dataCopied||navigator&&navigator.clipboard)){var c={title:jSuites.translate("Paste"),icon:"content_paste",shortcut:a+" V",onclick:function(){n.current.selectedCell&&(o.options.allow_pastestyle?o.paste():o.pasteOnlyValue())}};t.splice(l+1,0,c)}if(o.options.allow_pastestyle&&-1!=l&&(n.styleCopied||navigator&&navigator.clipboard)){var u={title:o.options.text_paste_special,submenu:[{title:o.options.text_paste_only_value,onclick:function(){n.current.selectedCell&&o.pasteOnlyValue()}},{title:o.options.text_paste_only_style,onclick:function(){n.current.selectedCell&&o.pasteOnlyStyle()}}]};t.splice(l+2,0,u)}}return t},o.toolbar=function(e){var t={type:"i",content:"content_paste",onclick:function(){n.current.selectedCell&&o.paste()}},r={type:"i",content:"content_cut",onclick:function(){n.current.selectedCell&&n.current.copy(!0)}},a={type:"i",content:"content_copy",onclick:function(){n.current.selectedCell&&n.current.copy()}};for(var s in e.items){if("redo"==e.items[s].content){e.items.splice(parseInt(s)+1,0,t),e.items.splice(parseInt(s)+1,0,a),e.items.splice(parseInt(s)+1,0,r);break}}return e},o.onevent=function(e){if("oncopy"==e){n.dataCopied=arguments[3];var t=arguments[1],r=arguments[2];if(o.options.allow_pastestyle&&t.options.style){for(var a=parseInt(r[0]),s=parseInt(r[1]),l=parseInt(r[2]),i=parseInt(r[3]),p=[],c=s;c<=i;c++){for(var u=[],d=a;d<=l;d++){var y=n.helpers.getColumnNameFromCoords(d,c);u.push(t.options.style[y])}p.push(u)}n.styleCopied=p}else n.styleCopied=null}},o.copy=function(e){if(n.current)return n.current.copy(e)},o.paste=function(e){null==e&&(e=!1);var t=parseInt(n.current.selectedCell[0]),r=parseInt(n.current.selectedCell[1]);if(navigator&&navigator.clipboard)navigator.clipboard.read().then((function(a){a[0].getType("text/plain").then((function(a){var s=new Response(a).text().then((function(a){if(e||!o.options.allow_pastestyle){var s=n.current.borders.copying;n.current.borders.copying=null}a&&n.current.paste(t,r,a),!e&&o.options.allow_pastestyle||(n.current.borders.copying=s)}));return s})),o.options.allow_pastestyle&&!e&&a[0].getType("text/html").then((function(e){return new Response(e).text().then((function(e){s(e)}))}))})).catch((function(a){if(n.dataCopied){if(e||!o.options.allow_pastestyle){var s=n.current.borders.copying;n.current.borders.copying=null}n.current.paste(t,r,n.dataCopied),!e&&o.options.allow_pastestyle||(n.current.borders.copying=s)}o.options.allow_pastestyle&&!e&&!n.current.borders.copying&&n.styleCopied&&o.pasteOnlyStyle()}));else if(n.dataCopied){if(e||!o.options.allow_pastestyle){var a=n.current.borders.copying;n.current.borders.copying=null}n.current.paste(t,r,n.dataCopied),!e&&o.options.allow_pastestyle||(n.current.borders.copying=a),o.options.allow_pastestyle&&!e&&!n.current.borders.copying&&n.styleCopied&&o.pasteOnlyStyle()}},o.pasteOnlyStyle=function(){var e=null;if(n.current.borders.copying){var t=[n.current.borders.copying.x1,n.current.borders.copying.y1,n.current.borders.copying.x2,n.current.borders.copying.y2];if(n.current.options.style){for(var o=parseInt(t[0]),r=parseInt(t[1]),a=parseInt(t[2]),l=parseInt(t[3]),i=[],p=r;p<=l;p++){for(var c=[],u=o;u<=a;u++){var d=n.helpers.getColumnNameFromCoords(u,p);c.push(n.current.options.style[d])}i.push(c)}e=i}}else navigator&&navigator.clipboard?navigator.clipboard.read().then((function(e){e[0].getType("text/html").then((function(e){return new Response(e).text().then((function(e){s(e)}))}))})):e=n.styleCopied;if(e){u=parseInt(n.current.selectedCell[0]),p=parseInt(n.current.selectedCell[1]);for(var y={},f=0;f<e.length;f++){c=e[f];for(var v=0;v<c.length;v++){i=c[v];y[d=n.helpers.getColumnNameFromCoords(u+v,p+f)]=i}}n.current.setStyle(y,null,null,!0)}},o.pasteOnlyValue=function(){o.paste(!0)},o.options.allow_pastestyle){var i=n.events.paste;n.pasteControls=function(e){(i(e),n.current&&n.current.selectedCell)&&(n.current.edition||(e&&e.clipboardData&&e.clipboardData.types&&e.clipboardData.getData?(e.clipboardData.types instanceof DOMStringList&&e.clipboardData.types.contains("text/html")||e.clipboardData.types.indexOf&&-1!==e.clipboardData.types.indexOf("text/html"))&&s(e.clipboardData.getData("text/html")):window.clipboardData&&window.clipboardData.types&&window.clipboardData.getData&&(window.clipboardData.types instanceof DOMStringList&&window.clipboardData.types.contains("text/html")||window.clipboardData.types.indexOf&&-1!==window.clipboardData.types.indexOf("text/html"))&&s(window.clipboardData.getData("text/html"))))}}return o}}));